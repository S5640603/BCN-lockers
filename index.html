<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barcelona Lockers Navigation</title>
  <!-- Mappa Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
  <style>
    body, html, #map { 
      margin: 0; 
      padding: 0; 
      width: 100%; 
      height: 100%; 
    }
    .locker-marker {
      font-size: 24px;
      color: #EA4335; /* Rosso Google */
      text-shadow: 0 0 3px white;
      transform: translate(-50%, -100%); /* Allineamento preciso */
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // 1. Inizializzazione mappa
    mapboxgl.accessToken = 'pk.eyJ1IjoiZW1hbnVsZWxlIiwiYSI6ImNtYm81ZnQzNTE0czkyanF5OXE4YmRnZ3oifQ.suw4swpVFR1lqHa_-50-gA';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [2.1734, 41.3851], // Centro Barcellona
      zoom: 12
    });

    // 2. Aggiungi marcatori armadietti
    const lockers = [
      { id: 1, name: "BCN Airport", coordinates: [2.0833, 41.2974] },
      { id: 2, name: "Barcelona Sants", coordinates: [2.1406, 41.3796] },
      { id: 3, name: "EstaciÃ³ de FranÃ§a", coordinates: [2.1836, 41.3850] },
      { id: 4, name: "Passeig de GrÃ cia", coordinates: [2.1657, 41.3919] },
      { id: 5, name: "Clot-AragÃ³", coordinates: [2.1864, 41.4106] },
      { id: 6, name: "Barcelona Nord", coordinates: [2.1814, 41.3936] }
    ];

    map.on('load', () => {
      lockers.forEach(locker => {
        const el = document.createElement('div');
        el.className = 'locker-marker';
        el.innerHTML = 'ðŸ”’';
        
        new mapboxgl.Marker(el)
          .setLngLat(locker.coordinates)
          .setPopup(new mapboxgl.Popup().setHTML(`
            <h3 style="color:#4285F4">${locker.name}</h3>
            <p>ID: ${locker.id}</p>
          `))
          .addTo(map);
      });
    });

    // 3. FUNZIONE ESSENZIALE per MIT App Inventor
    window.drawRoute = (routeData) => {
      try {
        const data = JSON.parse(routeData);
        
        // Rimuovi percorso esistente
        if (map.getSource('route')) {
          map.removeLayer('route');
          map.removeSource('route');
        }
        
        // Aggiungi nuovo percorso
        map.addLayer({
          id: 'route',
          type: 'line',
          source: {
            type: 'geojson',
            data: data.routes[0].geometry
          },
          paint: {
            'line-color': '#4285F4',
            'line-width': 4,
            'line-opacity': 0.7
          }
        });
        
        // Adatta la mappa al percorso
        const bounds = new mapboxgl.LngLatBounds();
        data.routes[0].geometry.coordinates.forEach(coord => {
          bounds.extend(coord);
        });
        map.fitBounds(bounds, { padding: 50 });

      } catch (error) {
        console.error("Errore drawRoute:", error);
      }
    };

    // 4. Funzione per debug
    window.showError = (message) => {
      alert("Errore: " + message);
    };
  </script>
</body>
</html>
