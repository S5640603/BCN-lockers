<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StuPiso Lockers</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <style>
    #map { position: fixed; top: 0; bottom: 0; width: 100%; }
    .marker {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Emoji_u1f511.svg/32px-Emoji_u1f511.svg.png');
      background-size: cover;
      width: 32px;
      height: 32px;
      cursor: pointer;
    }
    .arrival-alert {
      position: absolute;
      bottom: 20px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="arrivalAlert" class="arrival-alert">
    <h3>Sei arrivato!</h3>
    <p id="otpDisplay">Codice: 123456</p>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZW1hbnVsZWxlIiwiYSI6ImNtYm81ZnQzNTE0czkyanF5OXE4YmRnZ3oifQ.suw4swpVFR1lqHa_-50-gA';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [2.1686, 41.3874],
      zoom: 13
    });

    const lockers = [
      { id: "BCN_Airport", name: "BCN Airport", coordinates: [2.0833, 41.2974] },
      { id: "Barcelona_Sants", name: "Barcelona Sants", coordinates: [2.1406, 41.3796] },
      { id: "Estacio_Franca", name: "Estació de França", coordinates: [2.1836, 41.3850] },
      { id: "Passeig_Gracia", name: "Passeig de Gràcia", coordinates: [2.1657, 41.3919] },
      { id: "Clot_Arago", name: "Clot-Aragó", coordinates: [2.1864, 41.4106] },
      { id: "Barcelona_Nord", name: "Barcelona Nord", coordinates: [2.1814, 41.3936] }
    ];

    let userMarker = null;
    let routeLayer = null;
    let checkInterval = null;

    map.on('load', () => {
      lockers.forEach(locker => {
        const el = document.createElement('div');
        el.className = 'marker';

        new mapboxgl.Marker(el)
          .setLngLat(locker.coordinates)
          .setPopup(new mapboxgl.Popup().setHTML(`<b>${locker.name}</b>`))
          .addTo(map);

        el.addEventListener('click', () => {
          window.AppInventor?.setWebViewString?.(`locker_selected:${locker.id}`);
        });
      });
    });

    window.startNavigation = (userLng, userLat, lockerId) => {
      const locker = lockers.find(l => l.id === lockerId);
      if (!locker) return;

      if (userMarker) userMarker.remove();
      if (routeLayer) {
        map.removeLayer('route');
        map.removeSource('route');
      }
      if (checkInterval) clearInterval(checkInterval);

      userMarker = new mapboxgl.Marker({ color: '#4CAF50' })
        .setLngLat([userLng, userLat])
        .addTo(map);

      fetch(`https://api.mapbox.com/directions/v5/mapbox/walking/${userLng},${userLat};${locker.coordinates[0]},${locker.coordinates[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`)
        .then(res => res.json())
        .then(data => {
          const route = data.routes[0].geometry;

          map.addLayer({
            id: 'route',
            type: 'line',
            source: {
              type: 'geojson',
              data: {
                type: 'Feature',
                properties: {},
                geometry: route
              }
            },
            paint: {
              'line-color': '#3b82f6',
              'line-width': 4
            }
          });

          const bounds = new mapboxgl.LngLatBounds();
          bounds.extend([userLng, userLat]);
          bounds.extend(locker.coordinates);
          map.fitBounds(bounds, { padding: 50 });

          startPositionTracking(locker.coordinates);
        });
    };

    function startPositionTracking(destination) {
      checkInterval = setInterval(() => {
        window.AppInventor.getLocation((lng, lat) => {
          if (!lng || !lat) return;

          userMarker.setLngLat([lng, lat]);

          const distance = turf.distance(
            turf.point([lng, lat]),
            turf.point(destination),
            { units: 'kilometers' }
          );

          if (distance < 0.05) {
            document.getElementById('otpDisplay').textContent = `Codice: ${window.currentOTP || '123456'}`;
            document.getElementById('arrivalAlert').style.display = 'block';
            clearInterval(checkInterval);
            window.AppInventor.setWebViewString('arrival:true');
          }
        });
      }, 5000);
    }

    window.Android = {
      notify: message => window.AppInventor.setWebViewString(message),
      setOTP: otp => { window.currentOTP = otp; }
    };
  </script>
</body>
</html>
